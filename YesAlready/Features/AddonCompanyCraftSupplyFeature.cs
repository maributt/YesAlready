using System;
using System.Threading;

using ClickLib.Clicks;
using Dalamud.Logging;
using FFXIVClientStructs.FFXIV.Component.GUI;
using YesAlready.BaseFeatures;

namespace YesAlready.Features;

/// <summary>
/// AddonCompanyCraftSupply feature.
/// </summary>
internal class AddonCompanyCraftSupplyFeature : OnSetupFeature
{
    private static readonly uint RedeployBtnId = 47U;
    private static readonly uint FinalizeBtnId = 48U;

    /// <summary>
    /// Initializes a new instance of the <see cref="AddonCompanyCraftSupplyFeature"/> class.
    /// </summary>
    public AddonCompanyCraftSupplyFeature()
        : base("48 89 5C 24 ?? 48 89 6C 24 ?? 48 89 74 24 ?? 48 89 7C 24 ?? 41 54 41 56 41 57 48 83 EC 30 4D 8B F0 48 8D 99 ?? ?? ?? ?? 44 8B FA 48 8B F1 BD ?? ?? ?? ?? 45 33 E4 66 66 0F 1F 84 00 ?? ?? ?? ?? 8D 55 0F 48 8B CE E8 ?? ?? ?? ?? 48 8B C8 E8 ?? ?? ?? ?? BA ?? ?? ?? ?? 48 89 43 F8 48 8B C8 E8 ?? ?? ?? ?? 48 8B C8 E8 ?? ?? ?? ?? 48 8B 4B F8 BA ?? ?? ?? ?? 48 89 03 E8 ?? ?? ?? ?? 8D 55 14 48 89 43 08 48 8B CE E8 ?? ?? ?? ?? 48 8B 0B 48 89 43 10 48 85 C9 0F 84 ?? ?? ?? ?? 8D 45 FF 66 89 81 ?? ?? ?? ?? 48 8B 03 C7 80 ?? ?? ?? ?? ?? ?? ?? ?? 48 8B 03 C6 80 ?? ?? ?? ?? ?? 48 8B 03 80 88 ?? ?? ?? ?? ?? 48 8B 03 80 A0 ?? ?? ?? ?? ?? 48 8B 0B 48 85 C9 75 05 49 8B CC EB 07 48 8B 89 ?? ?? ?? ?? 44 88 64 24 ?? 4C 8B CE 44 8B C5 4C 89 64 24 ?? BA ?? ?? ?? ?? E8 ?? ?? ?? ?? 48 8B 0B 48 85 C9 75 05 49 8B CC EB 07 48 8B 89 ?? ?? ?? ?? 44 88 64 24 ?? 4C 8B CE 44 8B C5 4C 89 64 24 ?? BA ?? ?? ?? ?? E8 ?? ?? ?? ?? 48 8B 0B 48 85 C9 75 05 49 8B CC EB 07 48 8B 89 ?? ?? ?? ?? 44 88 64 24 ?? 4C 8B CE 44 8B C5 4C 89 64 24 ?? BA ?? ?? ?? ?? E8 ?? ?? ?? ?? FF C5 48 83 C3 20 8D 45 FF 83 F8 04 0F 82 ?? ?? ?? ?? BA ?? ?? ?? ?? 48 8B CE E8 ?? ?? ?? ?? 48 89 86 ?? ?? ?? ?? 48 85 C0 74 1D 4C 8B 00 33 D2 48 8B C8 41 FF 50 50 48 8B 86 ?? ?? ?? ?? 81 88 ?? ?? ?? ?? ?? ?? ?? ?? BA ?? ?? ?? ?? 48 8B CE E8 ?? ?? ?? ?? BA ?? ?? ?? ?? 48 89 86 ?? ?? ?? ?? 48 8B CE 4C 89 A6 ?? ?? ?? ?? E8 ?? ?? ?? ?? BF ?? ?? ?? ?? 48 89 86 ?? ?? ?? ?? 48 8D 9E ?? ?? ?? ?? 8D 6F E1")
    {
    }

    /// <inheritdoc/>
    protected override string AddonName => "CompanyCraftSupply";

    /// <inheritdoc/>
    protected unsafe override void OnSetupImpl(IntPtr addon, uint a2, IntPtr data)
    {
        if (!Service.Configuration.CompanyCraftSupplyAutoRepair)
            return;

        var add = (AtkUnitBase*)addon;
        new Thread(() =>
        {
            for (uint i = 0; i < 4; i++)
            {
                var item = add->GetNodeById(16 + i);
                var img = (AtkImageNode*)item->GetAsAtkComponentNode()->Component->UldManager.NodeList[2];
                if (!img->AtkResNode.IsVisible) ClickCompanyCraftSupply.Using(addon).RepairPart(i);
                Thread.Sleep(250);
            }
        }).Start();
    }
}